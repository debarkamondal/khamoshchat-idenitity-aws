# Agent Guidelines for khamoshchat-identity-aws

This repository is an AWS CDK project using TypeScript. Follow these guidelines to ensure consistency and quality.

## 1. Build, Lint, and Test Commands

### Build
- **Compile TypeScript:**
  ```bash
  npm run build
  ```
  This runs `tsc` to compile the project.

### Test
- **Run all tests:**
  ```bash
  npm test
  ```
  This runs `jest`.

- **Run a single test file:**
  ```bash
  npx jest test/path/to/test.ts
  ```

- **Run a specific test case:**
  ```bash
  npx jest -t "test name"
  ```

### Linting & Formatting
- **Linting:** No explicit linter (ESLint) is currently configured in `package.json`. Rely on `tsc` for type checking.
- **Formatting:** Follow the existing indentation (2 spaces) and style.
- **Type Checking:**
  ```bash
  npx tsc --noEmit
  ```

### CDK Commands
- **Synthesize CloudFormation template:**
  ```bash
  npm run cdk synth
  ```
- **Deploy:**
  ```bash
  npm run cdk deploy
  ```
- **Diff:**
  ```bash
  npm run cdk diff
  ```

## 2. Code Style Guidelines

### General
- **Language:** TypeScript (target ES2022, NodeNext module resolution).
- **Indentation:** 2 spaces.
- **Quotes:** Double quotes `"` are prevalent for imports and strings, though single quotes `'` are also used. Prefer double quotes for consistency with `bin/khamoshchat-identity-aws.ts` and `tsconfig.json`.
- **Semicolons:** Always use semicolons.

### Imports
- **Grouping:** Group imports by:
  1. External libraries (e.g., `aws-cdk-lib`, `dotenv`).
  2. Internal modules (relative paths).
- **Syntax:**
  - Use named imports where possible: `import { Construct } from 'constructs';`.
  - Use namespace imports for large libraries if established pattern: `import * as cdk from 'aws-cdk-lib';`.

### Naming Conventions
- **Classes:** PascalCase (e.g., `InfrastructureStack`, `ApiStack`).
- **Variables/Functions:** camelCase (e.g., `infraStack`, `addDependency`).
- **Files:** kebab-case (e.g., `khamoshchat-identity-aws.ts`, `api-stack.ts`).
- **Environment Variables:** UPPER_SNAKE_CASE (e.g., `BACKEND_DOMAIN_NAME`, `CERT_ARN`).

### CDK Patterns
- **Stack Separation:** Infrastructure (DynamoDB, etc.) and API logic are separated into different stacks (`InfrastructureStack`, `ApiStack`).
- **Config Passing:** Use a shared config interface (e.g., `SharedConfig`) to pass environment-specific configuration.
- **Construct IDs:** Use readable, deterministic IDs for constructs.
- **Dependencies:** Explicitly define stack dependencies using `stack.addDependency()`.

### Error Handling
- Use `try/catch` blocks for async operations, especially within Lambda functions or scripts.
- Ensure environment variables are validated or have sensible defaults (as seen in `bin/khamoshchat-identity-aws.ts`).

### Types
- **Strictness:** `strict: true` is enabled in `tsconfig.json`. Avoid `any`.
- **Interfaces:** Define interfaces for stack props and configuration objects.

## 3. Project Structure
- `bin/`: Entry point for the CDK app.
- `lib/`: Construct definitions and stack implementations.
- `test/`: Unit tests using Jest.
- `lambda/`: Contains the backend logic, primarily written in Rust (Cargo Lambda).
- `cdk.out/`: Synthesized CloudFormation templates (ignored in git).

## 4. Environment Setup
- **.env:** Used for local environment variables (e.g., `BACKEND_DOMAIN_NAME`, `CERT_ARN`).
- **cdk.context.json:** Context values for CDK.

## 5. Lambda Functions (Rust)

### Structure & Routing
- The `lambda/` directory is organized by functionality (e.g., `lambda/register`).
- **One Lambda, Multiple Routes:** Each folder represents a Rust project (Cargo Lambda). A single Lambda function often handles multiple API Gateway routes.
  - *Example:* The `lambda/register` project handles both `/register/phone` and `/register/otp`.
- **Internal Routing:** The Rust code uses `http_handler.rs` to switch on the request path and method (e.g., `match (method, path)`).
- **Trigger:** Lambdas are triggered via Amazon API Gateway (HTTP API), defined in `lib/api-stack.ts`.

### Development (Rust)
- **Framework:** Uses `lambda_http` and `tokio`.
- **Crypto:** Uses `libsignal-dezire` for Signal protocol operations.
- **DynamoDB:** Uses `aws-sdk-dynamodb` for database interactions.
- **Main Entry:** `src/main.rs` initializes the AWS client and environment variables, then delegates to `src/http_handler.rs`.

### Configuration
- **Environment Variables:** Configuration is injected via environment variables defined in `lib/api-stack.ts`.
  - `PRIMARY_TABLE`: Main DynamoDB table name.
  - `TTL_TABLE`: Time-to-live DynamoDB table name.
  - `REGION`: AWS Region.
- **Permissions:** IAM permissions (e.g., Read/Write to DynamoDB) are explicitly granted in the CDK stack (`permissions: { db: "RW" }`).

---
*Generated by opencode*
